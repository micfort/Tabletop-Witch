<!DOCTYPE html>
<html>
<head lang="en">
	<meta charset="UTF-8">
	<title></title>
</head>
<body>

<div id="view"></div>
<script type="text/javascript" src="js/lib/require.js"></script>
<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="http://colorbrewer2.org/export/colorbrewer.js"></script>
<script>
	$(document).ready(function ()
	{
		require(["js/TacticalMap.js"], function (tacticalMap)
		{
			//test data
			var data =
			{
				"cellSize": {"x": 40, "y": 40},
				"gridSize": {"x": 15, "y": 15},

				"symbolList": [
					{"x": 1, "y": 1, "symbol": "1"},
					{"x": 1, "y": 2, "symbol": "B"},
					{"x": 5, "y": 3, "symbol": "M"}
				],

				"wallList": [
					{"direction": "b", "x": 1, "y": 2},
					{"direction": "b", "x": 2, "y": 2},
					{"direction": "t", "x": 3, "y": 2},
					{"direction": "r", "x": 5, "y": 2},
					{"direction": "l", "x": 9, "y": 2}
				]
			};

			//html
			$("#view").html('<p id="stateDescription"></p>' +
					'<p><canvas id="mapCanvas" width="0" height="0"></canvas></p>' +
					'<p>' +
					'<button type="button" id="btnAddWalls">Add walls</button>' +
					'<button type="button" id="btnRemoveWalls">Remove walls</button>' +
					'<button type="button" id="btnAddSymbol">Add symbols</button>' +
					'<button type="button" id="btnRemoveSymbol">Remove symbols</button>' +
					'</p>' +
					'<p><textarea id="taJsonMap" class="json" name="term" id="term" cols="80" rows="40"></textarea><button type="button" id="btnUpdate">Update screen</button></p>');

			var EmptyState =
			{
				description: "",
				click: function(x, y, direction) {}
			};

			var addWallState =
			{
				description: "Add walls...",
				click: function(x, y, direction)
				{
					data.wallList[data.wallList.length] = {"direction": direction, "x": x, "y": y};
					updateView();
				}
			};

			var removeWallState =
			{
				description: "Remove walls...",
				click: function(x, y, direction)
				{
					for(var i = 0; i < data.wallList.length; i++)
					{
						var tmp = data.wallList[i];
						if(tmp["direction"] == direction && tmp["x"] == x && tmp["y"] == y)
						{
							data.wallList.splice(i, 1);
						}
					}
					updateView();
				}
			};

			var addSymbolState =
			{
				description: "Add symbols...",
				click: function(x, y, direction)
				{
					var symbol = window.prompt("What symbol(s) do you want to add in this cell?","");
					data.symbolList[data.symbolList.length] = {"symbol": symbol, "x": x, "y": y};
					updateView();
				}
			};

			var removeSymbolState =
			{
				description: "Remove symbols...",
				click: function(x, y, direction)
				{
					for(var i = 0; i < data.symbolList.length; i++)
					{
						var tmp = data.symbolList[i];
						if(tmp["x"] == x && tmp["y"] == y)
						{
							data.symbolList.splice(i, 1);
						}
					}
					updateView();
				}
			};

			var currentState;

			var mouse = {isDown: false, x: 0, y: 0};

			//info is in data
			var map = data;

			//getting canvas
			var canvas = document.getElementById('mapCanvas');

			// get mouse pos relative to canvas
			function getMousePos(canvas, evt)
			{
				var rect = canvas.getBoundingClientRect();
				return {
					x: evt.clientX - rect.left,
					y: evt.clientY - rect.top
				};
			}

			function snapToGridPoints(map, p)
			{
				return {
					x: Math.round(p.x / map.cellSize.x) * map.cellSize.x,
					y: Math.round(p.y / map.cellSize.y) * map.cellSize.y
				};
			}

			function snapToCell(map, p)
			{
				var cell = {x: Math.floor(p.x / map.cellSize.x), y: Math.floor(p.y / map.cellSize.y)};
				return cell;
			}

			function snapToSides(map, p)
			{
				var pos = {x: (p.x % map.cellSize.x) / map.cellSize.x, y: (p.y % map.cellSize.y) / map.cellSize.x};
				var invertedPos = {x: 1 - pos.x, y: 1 - pos.y};
				var min = Math.min(pos.x, pos.y, invertedPos.x, invertedPos.y);
				if (pos.x == min)
				{
					return "l";
				}
				else if (pos.y == min)
				{
					return "t";
				}
				else if (invertedPos.x == min)
				{
					return "r";
				}
				else if (invertedPos.y == min)
				{
					return "b";
				}
				return "t";
			}

			function updateView()
			{
				tacticalMap.DrawMap(canvas, data);
				$("#taJsonMap").val(JSON.stringify(data, null, '\t'));
			}

			function changeState(newState)
			{
				currentState = newState;
				$('#stateDescription').html(currentState.description);
				console.log("change state");
			}

			// when mouse button is clicked and held
			$(canvas).on('mousemove', function (e)
			{
				var pos = getMousePos(canvas, e);
				mouse.x = pos.x;
				mouse.y = pos.y;
				if (mouse.isDown === true)
				{

				}
			});

			// when mouse button is clicked and held
			$(canvas).on('mousedown', function (e)
			{
				if (mouse.isDown === false)
				{
					mouse.isDown = true;

					var pos = getMousePos(canvas, e);
					x1 = pos.x;
					y1 = pos.y;
				}
			});

			$(window).on('mouseup', function (e)
			{
				if (mouse.isDown === true)
				{
					var pos = getMousePos(canvas, e);

					mouse.isDown = false;

					var direction = snapToSides(map, pos);
					var cell = snapToCell(map, pos);
					currentState.click(cell.x, cell.y, direction);

					/*pos = snapToGridPoints(map, pos);

					 var context = canvas.getContext('2d');
					 context.beginPath();
					 context.moveTo(pos.x - 5, pos.y - 5);
					 context.lineTo(pos.x + 5, pos.y + 5);
					 context.strokeStyle = "#FFFFFF";
					 context.lineWidth = 3;
					 context.stroke();*/
				}
			});

			$("#btnAddWalls").on('click', function(e)
			{
				changeState(addWallState);
			});

			$("#btnRemoveWalls").on('click', function(e)
			{
				changeState(removeWallState);
			});

			$("#btnAddSymbol").on('click', function(e)
			{
				changeState(addSymbolState);
			});

			$("#btnRemoveSymbol").on('click', function(e)
			{
				changeState(removeSymbolState);
			});

			$("#btnUpdate").on('click', function(e)
			{
				data = JSON.parse($("#taJsonMap").val());
				updateView();
			});

			changeState(EmptyState);
			updateView();
		});
	});
</script>

</body>
</html>